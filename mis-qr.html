<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <title>Mis C√≥digos QR - Sistema de Reservas</title>
    <link rel="manifest" href="/eventos/manifest.json">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            min-height: 100vh;
            padding-bottom: 40px;
        }

        .header {
            background: linear-gradient(135deg, #2B4C7E 0%, #3D5A80 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 18px;
            font-weight: 600;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.3s;
        }
        
        .btn-back:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading p {
            color: #666;
            font-size: 16px;
        }

        .empty-state {
            background: white;
            border-radius: 15px;
            padding: 60px 30px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .empty-state-icon {
            font-size: 72px;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            color: #333;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .empty-state p {
            color: #666;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2B4C7E 0%, #3D5A80 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .reserva-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .reserva-header {
            background: linear-gradient(135deg, #2B4C7E 0%, #3D5A80 100%);
            color: white;
            padding: 15px 20px;
        }

        .reserva-fecha {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .reserva-id {
            font-size: 13px;
            opacity: 0.9;
        }

        .reserva-body {
            padding: 25px;
        }

        .qr-section {
            border-bottom: 1px solid #f0f0f0;
            padding: 20px 0;
        }

        .qr-section:last-child {
            border-bottom: none;
        }
        .qr-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 3px solid #2B4C7E;
        }
        .qr-icon {
            font-size: 32px;
        }

        .qr-title {
            flex: 1;
        }

        .qr-title h4 {
            color: #2B4C7E;
            font-size: 16px;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .qr-title p {
            color: #666;
            font-size: 13px;
        }

        .estado-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .estado-confirmado {
            background: #E8EAF6;
            color: #2B4C7E;
            display: none;
        }
        
        .estado-consumido {
            background: #d4edda;
            color: #155724;
        }

        .qr-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .qr-code-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .qr-code-container:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(43, 76, 126, 0.3);
        }

        .qr-code {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .qr-code canvas,
        .qr-code img {
            display: block !important;
            margin: 0 auto;
        }

        .qr-info {
            text-align: center;
            color: #666;
            max-width: 400px;
        }

        .qr-info p {
            margin-bottom: 0;
        }

        .qr-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px 15px;
            border-radius: 10px;
            font-size: 13px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .alert.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .notificacion-flotante {
        position: fixed;
        top: -100px;
        left: 50%;
        transform: translateX(-50%);
        background: white;
        padding: 20px 30px;
        border-radius: 15px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        z-index: 10000;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: top 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        min-width: 320px;
        max-width: 90%;
    }
    
    .notificacion-flotante.show {
        top: 30px;
    }
    
    .notificacion-contenido {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .notificacion-icono {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        flex-shrink: 0;
    }
    
    .notificacion-flotante.success .notificacion-icono {
        background: #4CAF50;
        color: white;
    }
    
    .notificacion-flotante.error .notificacion-icono {
        background: #f44336;
        color: white;
    }
    
    .notificacion-flotante.warning .notificacion-icono {
        background: #ff9800;
        color: white;
    }
    
    .notificacion-mensaje {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        line-height: 1.4;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .notificacion-flotante {
            min-width: 280px;
            padding: 15px 20px;
        }
        
        .notificacion-icono {
            width: 40px;
            height: 40px;
            font-size: 24px;
        }
        
        .notificacion-mensaje {
            font-size: 14px;
        }
    }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .qr-code {
                width: 180px;
                height: 180px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <button class="btn-back" onclick="volverInicio()">
                ‚Üê Volver al Inicio
            </button>
            <h1>üì± Mis Reservas</h1>
        </div>
    </div>

    <div class="container">
        <div id="alert" class="alert"></div>

        <div id="loadingContainer" class="loading">
            <div class="spinner"></div>
            <p>Cargando tus reservas...</p>
        </div>

        <div id="emptyState" class="empty-state" style="display: none;">
            <div class="empty-state-icon">üì≠</div>
            <h3>No tienes reservas activas</h3>
            <p>A√∫n no has realizado ninguna reserva.<br>Reserva tus alimentos para generar tus c√≥digos QR.</p>
            <button class="btn-primary" onclick="irAReservas()">
                Realizar Reserva
            </button>
        </div>

        <div id="reservasList" style="display: none;">
            <!-- Aqu√≠ se cargar√°n las reservas con sus QR -->
        </div>
            <div id="notificacionFlotante" class="notificacion-flotante">
        <div class="notificacion-contenido">
            <div class="notificacion-icono">‚úì</div>
            <div class="notificacion-mensaje"></div>
        </div>
    </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        function volverInicio() {
            window.location.href = CONFIG.ROUTES.HOME;
        }

        function irAReservas() {
            window.location.href = CONFIG.ROUTES.RESERVAS;
        }

        function mostrarAlerta(mensaje, tipo = 'error') {
            const alert = document.getElementById('alert');
            alert.textContent = mensaje;
            alert.className = `alert alert-${tipo} show`;
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 5000);
        }
        // ‚úÖ AGREGAR DESPU√âS DE LA FUNCI√ìN mostrarAlerta:

function mostrarNotificacionFlotante(mensaje, tipo = 'success') {
    const notificacion = document.getElementById('notificacionFlotante');
    const mensajeDiv = notificacion.querySelector('.notificacion-mensaje');
    const iconoDiv = notificacion.querySelector('.notificacion-icono');
    
    // Configurar mensaje
    mensajeDiv.textContent = mensaje;
    
    // Configurar √≠cono seg√∫n tipo
    if (tipo === 'success') {
        iconoDiv.textContent = '‚úì';
    } else if (tipo === 'error') {
        iconoDiv.textContent = '‚úó';
    } else if (tipo === 'warning') {
        iconoDiv.textContent = '‚ö†';
    }
    
    // Aplicar clases
    notificacion.className = `notificacion-flotante ${tipo}`;
    
    // Mostrar
    setTimeout(() => {
        notificacion.classList.add('show');
    }, 100);
    
    // Ocultar despu√©s de 4 segundos
    setTimeout(() => {
        notificacion.classList.remove('show');
    }, 4000);
}
        function formatearHora(hora24) {
            if (!hora24) return '';
            
            const [horas, minutos] = hora24.split(':');
            let h = parseInt(horas);
            const periodo = h >= 12 ? 'PM' : 'AM';
            
            h = h % 12;
            h = h === 0 ? 12 : h;
            
            return `${h}:${minutos} ${periodo}`;
        }

        async function cargarReservas() {
            try {
                const userData = auth.getUserData();
                if (!userData) {
                    mostrarEstadoVacio();
                    return;
                }

                console.log('üîç Buscando reservas para usuario:', userData.usuario_id);

                // Consultar reservas activas del usuario con sus detalles
               const url = `${CONFIG.SUPABASE_URL}/rest/v1/reserva?id_usuario=eq.${userData.usuario_id}&activo=eq.true&select=*,programacion(id,fecha),detalle_reserva(id,tipo_racion,confirmado,consumido,qr_code)&order=fecha_reserva.desc`;
                
                const response = await fetch(url, {
                    headers: {
                        'apikey': CONFIG.SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Error cargando reservas');
                }

                const reservas = await response.json();
                console.log('üìã Reservas encontradas:', reservas);

                if (reservas.length === 0) {
                    mostrarEstadoVacio();
                } else {
                    renderizarReservas(reservas);
                }

            } catch (error) {
                console.error('‚ùå Error:', error);
                mostrarAlerta('Error al cargar las reservas', 'error');
                mostrarEstadoVacio();
            }
        }

        function mostrarEstadoVacio() {
            document.getElementById('loadingContainer').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
        }
        async function obtenerHorarioReserva(idProgramacion, tipoRacion) {
    try {
        const url = `${CONFIG.SUPABASE_URL}/rest/v1/programacion_horario_cantidad?id_programacion=eq.${idProgramacion}&tip_rac=eq.${tipoRacion}&cantidad_reservada=gt.0&select=hora_inicio,hora_fin&limit=1`;
        
        const response = await fetch(url, {
            headers: {
                'apikey': CONFIG.SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
            }
        });

        const data = await response.json();
        if (data && data.length > 0) {
            return {
                hora_inicio: data[0].hora_inicio,
                hora_fin: data[0].hora_fin
            };
        }
        return null;
    } catch (error) {
        console.error('Error obteniendo horario:', error);
        return null;
    }
}

        async function renderizarReservas(reservas) {
            const container = document.getElementById('reservasList');
            container.innerHTML = '';
        
            for (const reserva of reservas) {
                const card = await crearTarjetaReserva(reserva);
                container.appendChild(card);
            }
        
            document.getElementById('loadingContainer').style.display = 'none';
            container.style.display = 'block';
        }
async function crearTarjetaReserva(reserva) {
    const card = document.createElement('div');
    card.className = 'reserva-card';

    const fecha = new Date(reserva.programacion.fecha + 'T00:00:00');
    const fechaFormateada = fecha.toLocaleDateString('es-PE', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });

    const iconos = {
        DESAYUNO: '‚òÄÔ∏è',
        ALMUERZO: 'üçΩÔ∏è',
        CENA: 'üåô'
    };

    // ‚úÖ OBTENER HORARIOS
    const horariosPromises = reserva.detalle_reserva
        .filter(det => det.qr_code)
        .map(async detalle => {
            const horario = await obtenerHorarioReserva(reserva.id_programacion, detalle.tipo_racion);
            return { detalle, horario };
        });
    
    const detallesConHorario = await Promise.all(horariosPromises);

    const detallesHTML = detallesConHorario.map(({ detalle, horario }) => {
        const estado = detalle.consumido ? 'consumido' : 'confirmado';
        const estadoTexto = detalle.consumido ? 'Consumido' : 'Activo';
        
        const horarioBadge = horario 
            ? `<span class="estado-badge" style="background: #fff3cd; color: #856404;">üïê ${formatearHora(horario.hora_inicio)} - ${formatearHora(horario.hora_fin)}</span>`
            : '';
        
        return `
            <div class="qr-section">
            <div class="qr-header">
                <span class="qr-icon">${iconos[detalle.tipo_racion]}</span>
                <div class="qr-title" style="flex: 1;">
                    <h4>${detalle.tipo_racion}</h4>
                    <p style="margin-bottom: 8px;">${fechaFormateada}</p>
                    ${horarioBadge}
                </div>
            </div>          
                <div class="qr-content">
                    <div class="qr-code-container">
                        <div class="qr-code" id="qr-${detalle.id}"></div>
                    </div>
                    <div class="qr-info">
                        <p><strong>Presenta este c√≥digo para retirar tu ${detalle.tipo_racion.toLowerCase()}</strong></p>
                        ${!detalle.consumido ? `
                            <div class="qr-warning">
                                ‚ö†Ô∏è <span>Este c√≥digo es de un solo uso. Una vez escaneado, no podr√° usarse nuevamente.</span>
                            </div>
                            <button 
                                class="btn-cancelar-detalle" 
                                data-detalle-id="${detalle.id}"
                                data-tipo-racion="${detalle.tipo_racion}"
                                onclick="cancelarDetalleReserva('${detalle.id}', '${detalle.tipo_racion}')"
                                style="
                                    margin-top: 15px;
                                    width: 100%;
                                    padding: 12px;
                                    background: #f44336;
                                    color: white;
                                    border: none;
                                    border-radius: 8px;
                                    font-weight: 600;
                                    cursor: pointer;
                                    transition: all 0.3s;
                                "
                            >
                                ‚úó Cancelar ${detalle.tipo_racion}
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    card.innerHTML = `
        <div class="reserva-header">
            <div class="reserva-fecha">üìÖ ${fechaFormateada}</div>            
        </div>
        <div class="reserva-body">
            ${detallesHTML}
        </div>
    `;

    setTimeout(() => {
        reserva.detalle_reserva.forEach(detalle => {
            if (detalle.qr_code) {
                const qrElement = document.getElementById(`qr-${detalle.id}`);
                if (qrElement) {
                    qrElement.innerHTML = '';
                    new QRCode(qrElement, {
                        text: detalle.qr_code,
                        width: 200,
                        height: 200,
                        colorDark: "#333333",
                        colorLight: "#ffffff",
                        correctLevel: QRCode.CorrectLevel.H
                    });
                    setTimeout(() => {
                        const imgs = qrElement.querySelectorAll('img');
                        imgs.forEach(img => img.remove());
                    }, 100);
                }
            }
        });
    }, 100);

    return card;
}  
            async function cancelarDetalleReserva(idDetalle, tipoRacion) {
                if (!confirm(`¬øConfirma cancelar la reserva de ${tipoRacion}?`)) {
                    return;
                }
            
                const btn = event.target;
                const textoOriginal = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Cancelando...';
            
                try {
                    const userData = auth.getUserData();
            
                    const response = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/rpc/sp_cancelar_detalle_reserva`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': CONFIG.SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify({
                            p_id_detalle_reserva: idDetalle,
                            p_id_usuario: userData.usuario_id
                        })
                    });
            
                    const result = await response.json();
            
                    if (!result.success) {
                        mostrarNotificacionFlotante(result.error, 'error');
                        btn.disabled = false;
                        btn.innerHTML = textoOriginal;
                        return;
                    }
                
                    mostrarNotificacionFlotante('‚úì Reserva cancelada exitosamente', 'success');
                    
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                
                } catch (error) {
                    console.error('Error:', error);
                    mostrarNotificacionFlotante('Error al cancelar la reserva', 'error');
                    btn.disabled = false;
                    btn.innerHTML = textoOriginal;
                }
            }
        
        // Inicializar
        window.addEventListener('load', async () => {
            const acceso = await auth.protectPage();
            if (!acceso) return;

            await cargarReservas();
        });        
    </script>
    <script src="js/pwa-install.js?v=2.1.2"></script>
    <script src="js/pwa-update.js?v=2.1.2"></script>
</body>
</html>
